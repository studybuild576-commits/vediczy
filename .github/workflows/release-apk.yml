name: Verify SHA-1 Key

on:
  workflow_dispatch:

jobs:
  sha1-check:
    runs-on: ubuntu-latest

    env:
      CM_KEYSTORE: ${{ secrets.CM_KEYSTORE }}
      CM_KEYSTORE_PASSWORD: ${{ secrets.CM_KEYSTORE_PASSWORD }}
      CM_KEY_ALIAS: ${{ secrets.CM_KEY_ALIAS }}
      CM_KEY_PASSWORD: ${{ secrets.CM_KEY_PASSWORD }}
      ANDROID_SHA1_KEY: ${{ secrets.ANDROID_SHA1_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Decode keystore and save to a file
        run: echo "$CM_KEYSTORE" | base64 --decode > my-release-key.jks

      - name: Verify SHA-1 from Keystore
        run: |
          echo "üîê SHA-1 from keystore:"
          keytool -list -v \
            -keystore my-release-key.jks \
            -alias "$CM_KEY_ALIAS" \
            -storepass "$CM_KEYSTORE_PASSWORD" \
            -keypass "$CM_KEY_PASSWORD" | grep SHA1

      - name: Print Permanent SHA-1 from Secret
        run: |
          echo "üìÑ Permanent SHA-1 from secret:"
          echo "$ANDROID_SHA1_KEY"

      - name: Compare SHA-1 Keys
        run: |
          KEYSTORE_SHA1=$(keytool -list -v -keystore my-release-key.jks -alias "$CM_KEY_ALIAS" -storepass "$CM_KEYSTORE_PASSWORD" -keypass "$CM_KEY_PASSWORD" | grep SHA1 | cut -d ' ' -f 3)
          SECRET_SHA1="$ANDROID_SHA1_KEY"
          
          if [[ "$KEYSTORE_SHA1" == "$SECRET_SHA1" ]]; then
            echo "‚úÖ Success: Keystore SHA-1 matches the permanent key."
            exit 0
          else
            echo "‚ùå Error: Keystore SHA-1 does not match the permanent key."
            echo "Keystore SHA-1: $KEYSTORE_SHA1"
            echo "Secret SHA-1: $SECRET_SHA1"
            exit 1
          fi
